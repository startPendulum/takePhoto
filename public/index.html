<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Title</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="stylesheet" href="css/bootstrap.css">
</head>
<body class="bg-dark">
<section class="p-5 mt-lg-3">
	<div class="container">
		<div class="row">
			<div class="col-md-5 gx-5 p-3 text-center">
				<h5 class="text-danger lead">实时摄像头</h5>
				<video class="img-fluid"></video>
			</div>
			<div class="d-grid col-md-2 my-auto p-1">
				<div class="row py-4 px-2">
					<div class="d-grid col">
						<button type="button" class="btn btn-primary btn-lg" onclick="takePhoto()">拍 照</button>
					</div>
				</div>
				<div class="row p-2">
					<div class="d-grid col">
						<input type="radio" class="btn-check " name="color" id="red" autocomplete="off" value="red"
						       checked>
						<label class="btn btn-outline-danger" for="red">红色底</label>
					</div>
					<div class="d-grid col">
						<input type="radio" class="btn-check" name="color" id="green" autocomplete="off" value="green">
						<label class="btn btn-outline-success" for="green">绿色底</label>
					</div>
				</div>
				<div class="row p-2">
					<div class="d-grid col">
						<input type="radio" class="btn-check" name="color" id="blue" autocomplete="off" value="blue">
						<label class="btn btn-outline-primary" for="blue">蓝色底</label>
					</div>
					<div class="d-grid col">
						<input type="radio" class="btn-check" name="color" id="white" autocomplete="off" value="white">
						<label class="btn btn-outline-light" for="white">白色底</label>
					</div>
				</div>
				<div class="row py-4 px-2">
					<div class="d-grid col">
						<button
								type="button"
								class="btn btn-warning btn-lg text-light"
								id="submit"
								data-bs-toggle="modal"
								data-bs-target="#exampleModal"
						>
							提 交
						</button>
					</div>
				</div>
			</div>
			<div class="col-md-5 text-center p-3">
				<h5 class="text-danger text-center lead">照片</h5>
				<img src="" class="img-fluid">
				<canvas width="1000" height="1000" class="img-fluid w-auto bg-gradient"></canvas>
			</div>
		</div>
		<div class="modal fade" id="exampleModal">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">确定吗</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<h5>确定要使用这张图片吗？这API十分滴珍贵!</h5>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
						<button type="button" class="btn btn-primary" onclick="submit()" data-bs-dismiss="modal">确定</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>
<div class="waiting">
	<div class="card"  style="width: 25rem;">
		<img src="img/sese1.jpg" class="card-img-top sese img-fluid w-auto" alt="这里有图片">
		<div class="card-body">
			<p class="card-text text-center">处理中请稍后</p>
		</div>
	</div>
</div>

<script src="js/axios.js"></script>
<script src="js/bootstrap.bundle.js"></script>
<script>
	const canvas = document.getElementsByTagName("canvas")[0]
	canvas.style.margin = "auto"
	const video = document.getElementsByTagName("video")[0]
	const img = document.getElementsByTagName("img")[0]
	img.style.display = "none"
	const c = canvas.getContext("2d")
	const submitButton=document.getElementById("submit")
	const colorInput = document.getElementsByClassName("btn-check")
	axios.defaults.timeout = 30000;
	submitButton.setAttribute("disabled","true")
	let color=""


	navigator.mediaDevices.getUserMedia({
		video: {
			width: canvas.width,
			height: canvas.height,
		}
	})
	.then(stream => {
		video.srcObject = stream
		video.onloadedmetadata = () => {
			video.play()
		}
	})

	function takePhoto() {
		c.clearRect(0,0,1000,1000)
		c.drawImage(video, 0, 0, canvas.width, canvas.height)
		// let imageData=c.getImageData(0,0,canvas.width,canvas.height)
		let imgSrc=canvas.toDataURL()
		img.src=imgSrc
		// c.putImageData(imageData,0,0)
		submitButton.removeAttribute("disabled")
		canvas.style.display="none"
		img.style.display = "block"
	}

	function imageReversal(sourceData) {
		let newData=new Uint8ClampedArray(canvas.width*canvas.height*4)
		for(let y=0;y<canvas.height*canvas.width*4-1;y+=canvas.width*4){
			for (let x=0; x <canvas.width*4-1;x+=4) {
				newData[y+x]=sourceData[(y+canvas.width*4)-(x+4)]
				newData[y+(x+1)]=sourceData[(y+canvas.width*4)-(x+3)]
				newData[y+(x+2)]=sourceData[(y+canvas.width*4)-(x+2)]
				newData[y+(x+3)]=sourceData[(y+canvas.width*4)-(x+1)]
			}
		}
		return newData;
	}

	function getHexColor(data){
		for(let i=0;i<data.length;i++){

		}
	}

	function submitTest(){
		let waiting=document.getElementsByClassName("waiting")[0]
		let sese=document.getElementsByClassName("sese")[0]
		waiting.style.display="flex"
		waiting.style.alignItems="center"
		waiting.style.justifyContent="center"
		waiting.style.height=document.documentElement.offsetHeight+"px"
		waiting.style.width=document.documentElement.offsetWidth+"px"
		let i=2
		setInterval(()=>{
			if(i>3){
				i=1
			}
			sese.src=`img/sese${i}.jpg`
			i++
		},2000)
	}

	function submit() {
		let image = canvas.toDataURL("image/png")
		for (let i = 0; i < colorInput.length; i++) {
			if (colorInput[i].checked) {
				console.log(colorInput[i].value)
				color = colorInput[i].value
			}
		}
		let waiting=document.getElementsByClassName("waiting")[0]
		let sese=document.getElementsByClassName("sese")[0]
		waiting.style.display="flex"
		waiting.style.alignItems="center"
		waiting.style.justifyContent="center"
		waiting.style.height=document.documentElement.offsetHeight+"px"
		waiting.style.width=document.documentElement.offsetWidth+"px"

		let i=2
		let timer=setInterval(()=>{
			if(i>3){
				i=1
			}
			sese.src=`img/sese${i}.jpg`
			i++
		},2000)

		// console.log(image.split(","))
		//https://43.134.172.201/img
		//https://localhost:6666/img
		axios.post(
				`https://www.startpendulum.site/img`,
				{
					data: image.split(",")[1].toString(),
					color
				},
		)
		.then(response => {
			c.clearRect(0, 0, canvas.width, canvas.height)
			// canvas.height=500
			// canvas.width=500
			img.src = "data:image/png;base64," + response.data.data
			clearInterval(timer)
			waiting.style.display="none"

		})
		.catch(err => {
			console.log(err)
		})
	}
</script>
<style>
	.waiting{
		height: 100%;
		width: 100%;
		display: none;
		background-color: rgba(13,202,240,0.8);
		position: absolute;
		top: 0;
		left: 0;
	}
</style>
</body>
</html>
